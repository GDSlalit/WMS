
{% extends "layout.html" %}

{% block pageTitle %}
  Service list – {{ serviceName }} – NHS.UK prototype kit
{% endblock %}

{% block beforeContent %}
  <a class="govuk-back-link" href="javascript:window.history.back()">Back</a>
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds-from-desktop">

      <h1 class="govuk-heading-l">List of services available in your area</h1>
	  
    </div>
 </div>


<!DOCTYPE html>
<!-- saved from url=(0014)about:internet -->
<html lang="en">
<html>

<head>
  <title>WMS</title>

</head>  
  
  
  <script type="text/javascript">
	  let params = new URLSearchParams(window.location.search)
	  {
	  }

	  let pcode = params.get('postcode').replace(/ /g,'').toUpperCase()
	  {
		console.log('Postcode provided:' + pcode)
	  }	  
 
      function getLAcode(csv) {
		  let data = csv.split(/\r\n|\n/).map(v => v.split(','));

		  let headers = data.shift();
		  console.log(headers)
		  let csvpcode = "";

		  let rowcount = 1;
		  let row = "";
		  let csvfilename = "https://raw.githubusercontent.com/GDSlalit/WMS/main/testdata02.csv";
		  while (rowcount <= 1000 ) {
			row = data.shift();
			try {
			  csvpcode = row[0];
			}
			catch(err) {
			  console.log("End of file reached - Match not found - default ",csvfilename, "file used - rowcount: ", rowcount )
			  break;
			}			

			if (pcode == csvpcode) {
				csvfilename = "https://raw.githubusercontent.com/GDSlalit/WMS/main/"+ row[1] + ".csv";
				console.log("Match found for: ", csvpcode, "CSV file to use: ", csvfilename)
				break;
			} 
			else {
				rowcount++;
			}
		  }
		  return(csvfilename)				
		}
		
	
		function processData(csv) {

		  let data = csv.split(/\r\n|\n/).map(v => v.split(','));

		  let headers = data.shift();

		  let table = document.createElement('table');

		  let thead = document.createElement('thead');
		  table.appendChild(thead);

		  thead.innerHTML = '<tr><th>' + headers.join('</th><th>') + '</th></tr>';

		  let tbody = document.createElement('tbody');
		  table.appendChild(tbody);

		  for (let row of data) {
			tbody.innerHTML += '<tr><td>' + row.join('</td><td>') + '</td></tr>';
		  }

		  document.body.appendChild(table);
		}
		  
		// CSV from GitHub repo
		let postcodefile = "https://raw.githubusercontent.com/GDSlalit/WMS/main/postcode2LA.csv"

		fetch(postcodefile)
			.then(res => res.text())
			.then(text => {
				let csvfilename = getLAcode(text)
				console.log("CSV file to use: ", csvfilename)	
						
				fetch(csvfilename)
				.then(res => res.text())
				.then(text => processData(text))
			})
		
  </script>

</body>

</html>
 {% endblock %}